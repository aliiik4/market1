<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø±Ù…Ø²Ø§Ø±Ø² - CoinGecko</title>
    
    <!-- ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-fontface.css" rel="stylesheet">
    
    <!-- Ø§Ø³ØªØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        #app {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <p>Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø±Ù…Ø²Ø§Ø±Ø²...</p>
    </div>

    <div id="app" class="hidden">
        <header class="app-header">
            <h1><i data-lucide="trending-up"></i> Ø³ÛŒØ³ØªÙ… ØªØ­Ù„ÛŒÙ„ CoinGecko</h1>
            <p>Ù†Ù…Ø§ÛŒØ´ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ + Ù…Ø¯ÛŒØ±ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª API</p>
            <div class="header-info">
                <span>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <span id="lastUpdateTime">--:--:--</span></span>
                <span class="api-status">ÙˆØ¶Ø¹ÛŒØª API: <span id="apiStatus">âœ… Ø³Ø§Ù„Ù…</span></span>
            </div>
        </header>

        <main class="main-container">
            <section class="controls">
                <div class="search-box">
                    <i data-lucide="search"></i>
                    <input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø±Ù…Ø²Ø§Ø±Ø² (BTC, Ethereum...)" 
                           aria-label="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø±Ù…Ø²Ø§Ø±Ø²">
                </div>
                
                <div class="control-buttons">
                    <button id="btnRefresh" class="btn-primary">
                        <i data-lucide="refresh-cw"></i> Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                    </button>
                    <button id="btnTopGainers" class="btn-secondary">
                        <i data-lucide="trending-up"></i> Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø±Ø´Ø¯
                    </button>
                    <button id="btnClearCache" class="btn-warning">
                        <i data-lucide="trash-2"></i> Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† Ú©Ø´
                    </button>
                    
                    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ -->
                    <button id="btnShowAnalysis" class="btn-success">
                        <i data-lucide="bar-chart-3"></i> Ù†Ù…Ø§ÛŒØ´ ØªØ­Ù„ÛŒÙ„
                    </button>
                </div>
                
                <div class="stats">
                    <span><i data-lucide="database"></i> ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø± Ú©Ø´: <strong id="cachedCount">0</strong></span>
                    <span><i data-lucide="activity"></i> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: <strong id="rateLimitRemaining">30</strong>/Ø¯Ù‚ÛŒÙ‚Ù‡</span>
                </div>
            </section>

            <section class="content">
                <div class="crypto-grid" id="cryptoGrid">
                    <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø±Ù…Ø²Ø§Ø±Ø² Ø§ÛŒÙ†Ø¬Ø§ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                </div>

                <div class="detail-view hidden" id="detailView">
                    <div class="detail-header">
                        <h2 id="detailSymbol">Bitcoin (BTC)</h2>
                        <button id="btnCloseDetail" class="btn-close">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="detail-body">
                        <div class="price-chart-container">
                            <canvas id="priceChart"></canvas>
                        </div>
                        <div class="detail-stats">
                            <div class="stat-card">
                                <h4><i data-lucide="bar-chart"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ø²Ø§Ø±</h4>
                                <div class="stat-item">
                                    <span>Ù‚ÛŒÙ…Øª:</span>
                                    <strong id="statPrice">$0</strong>
                                </div>
                                <div class="stat-item">
                                    <span>ØªØºÛŒÛŒØ± 24h:</span>
                                    <strong id="statChange24h" class="positive">+0%</strong>
                                </div>
                                <div class="stat-item">
                                    <span>Ø­Ø¬Ù… Ø¨Ø§Ø²Ø§Ø±:</span>
                                    <strong id="statMarketCap">$0</strong>
                                </div>
                            </div>
                            <div class="stat-card">
                                <h4><i data-lucide="info"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙÙ†ÛŒ</h4>
                                <div class="stat-item">
                                    <span>Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ø§Ù…Ø±ÙˆØ²:</span>
                                    <strong id="statHigh24h">$0</strong>
                                </div>
                                <div class="stat-item">
                                    <span>Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ±ÛŒÙ† Ø§Ù…Ø±ÙˆØ²:</span>
                                    <strong id="statLow24h">$0</strong>
                                </div>
                                <div class="stat-item">
                                    <span>Ø¹Ø±Ø¶Ù‡ Ø¯Ø± Ú¯Ø±Ø¯Ø´:</span>
                                    <strong id="statCirculatingSupply">0</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ø¨Ø®Ø´ ØªØ­Ù„ÛŒÙ„ Ø¹Ù„ÛŒ -->
                <div class="analysis-section hidden" id="analysisSection">
                    <div class="analysis-header">
                        <h3><i data-lucide="bar-chart-3"></i> ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø§Ø± Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§</h3>
                        <button id="btnCloseAnalysis" class="btn-close">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="analysis-body" id="analysisBody">
                        <!-- ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                    </div>
                    <div class="creator-note">
                        <i data-lucide="heart"></i> Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ ØªÙˆØ³Ø· Ø¹Ù„ÛŒ
                    </div>
                </div>
            </section>
        </main>

        <footer class="app-footer">
            <p>
                <i data-lucide="shield-alert"></i>
                <strong>Ø±Ø§Ù‡â€ŒÚ©Ø§Ø± Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø­Ø¯ÙˆØ¯ÛŒØª:</strong> Ø§ÛŒÙ† Ø³ÛŒØ³ØªÙ… Ø¨Ø§ Ú©Ø´â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ØŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª 30 Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø± Ø¯Ù‚ÛŒÙ‚Ù‡ API Ø±Ø§ÛŒÚ¯Ø§Ù† CoinGecko Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
            </p>
            <p class="footer-note">
                Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² CoinGecko API Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾Ø§ÛŒØ¯Ø§Ø±ØªØ±ØŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©Ù„ÛŒØ¯ API Ø±Ø§ÛŒÚ¯Ø§Ù† (Demo Key) ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
            </p>
        </footer>
    </div>

    <!-- ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ JavaScript -->
    <script>
        // ÙØ§ÛŒÙ„ coinGeckoService.js
        class CoinGeckoService {
            constructor() {
                // Ú©Ù„ÛŒØ¯ API Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
                this.apiKey = 'CG-WFM5kXKGJNJyKb6T12YaAUPf'; // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯ Ø¨Ø§ Ú©Ù„ÛŒØ¯ ÙˆØ§Ù‚Ø¹ÛŒ
                this.baseURL = 'https://api.coingecko.com/api/v3';
                this.cacheDuration = 60000; // 1 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø´
                this.rateLimit = 30; // 30 Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø± Ø¯Ù‚ÛŒÙ‚Ù‡
                this.requests = [];
                this.apiStatus = 'healthy';
                this.rateLimitRemaining = 30;
            }

            getCacheKey(endpoint, params) {
                return `${endpoint}_${JSON.stringify(params)}`;
            }

            setCache(key, data) {
                const cacheData = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(`cg_${key}`, JSON.stringify(cacheData));
            }

            getCache(key) {
                const cached = localStorage.getItem(`cg_${key}`);
                if (!cached) return null;
                
                const cacheData = JSON.parse(cached);
                if (Date.now() - cacheData.timestamp > this.cacheDuration) {
                    localStorage.removeItem(`cg_${key}`);
                    return null;
                }
                
                return cacheData.data;
            }

            clearCache() {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('cg_')) {
                        localStorage.removeItem(key);
                    }
                });
            }

            getCachedCount() {
                return Object.keys(localStorage).filter(key => key.startsWith('cg_')).length;
            }

            async checkRateLimit() {
                const now = Date.now();
                this.requests = this.requests.filter(time => now - time < 60000);
                
                if (this.requests.length >= this.rateLimit) {
                    const oldestRequest = this.requests[0];
                    const waitTime = 60000 - (now - oldestRequest);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }

            async makeRequest(endpoint, params = {}) {
                await this.checkRateLimit();
                
                const cacheKey = this.getCacheKey(endpoint, params);
                const cachedData = this.getCache(cacheKey);
                if (cachedData) {
                    return cachedData;
                }

                try {
                    const url = new URL(`${this.baseURL}${endpoint}`);
                    Object.keys(params).forEach(key => {
                        if (params[key] !== undefined && params[key] !== null) {
                            url.searchParams.append(key, params[key]);
                        }
                    });

                    const headers = {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    };

                    if (this.apiKey && this.apiKey !== 'CG-xxxxx-xxxxx-xxxxx') {
                        headers['x-cg-demo-api-key'] = this.apiKey;
                    }

                    this.requests.push(Date.now());
                    
                    const response = await fetch(url, { headers });
                    
                    const remaining = response.headers.get('x-ratelimit-remaining');
                    if (remaining) {
                        this.rateLimitRemaining = parseInt(remaining);
                        this.updateRateLimitDisplay();
                    }
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    this.setCache(cacheKey, data);
                    
                    this.apiStatus = 'healthy';
                    this.updateApiStatus();
                    
                    return data;
                    
                } catch (error) {
                    console.error('API Request Error:', error);
                    this.apiStatus = 'error';
                    this.updateApiStatus();
                    
                    const cachedData = this.getCache(cacheKey);
                    if (cachedData) {
                        return cachedData;
                    }
                    throw error;
                }
            }

            updateApiStatus() {
                const statusElement = document.getElementById('apiStatus');
                if (statusElement) {
                    statusElement.textContent = this.apiStatus === 'healthy' ? 'âœ… Ø³Ø§Ù„Ù…' : 'âŒ Ù…Ø´Ú©Ù„';
                    statusElement.style.color = this.apiStatus === 'healthy' ? '#28a745' : '#dc3545';
                }
            }

            updateRateLimitDisplay() {
                const remainingElement = document.getElementById('rateLimitRemaining');
                if (remainingElement) {
                    remainingElement.textContent = this.rateLimitRemaining;
                    if (this.rateLimitRemaining < 10) {
                        remainingElement.style.color = '#dc3545';
                    } else if (this.rateLimitRemaining < 20) {
                        remainingElement.style.color = '#ffc107';
                    } else {
                        remainingElement.style.color = '#28a745';
                    }
                }
            }

            async getCoinsMarkets(vs_currency = 'usd', per_page = 50) {
                return this.makeRequest('/coins/markets', {
                    vs_currency,
                    per_page,
                    price_change_percentage: '1h,24h,7d'
                });
            }

            async getCoinData(coinId) {
                return this.makeRequest(`/coins/${coinId}`, {
                    localization: false,
                    tickers: false,
                    market_data: true,
                    community_data: false,
                    developer_data: false,
                    sparkline: true
                });
            }

            async getTopGainers() {
                const data = await this.getCoinsMarkets();
                return data
                    .sort((a, b) => b.price_change_percentage_24h - a.price_change_percentage_24h)
                    .slice(0, 10);
            }

            async searchCoins(query) {
                if (!query || query.length < 2) {
                    return this.getCoinsMarkets();
                }
                
                const data = await this.getCoinsMarkets();
                return data.filter(coin => 
                    coin.name.toLowerCase().includes(query.toLowerCase()) ||
                    coin.symbol.toLowerCase().includes(query.toLowerCase())
                );
            }
        }

        // ÙØ§ÛŒÙ„ app.js
        class CryptoApp {
            constructor() {
                this.service = new CoinGeckoService();
                this.currentData = [];
                this.chart = null;
                this.currentCoinId = null;
                
                this.init();
            }

            async init() {
                lucide.createIcons();
                this.setupEventListeners();
                await this.loadInitialData();
                this.hideLoading();
                this.updateCacheCount();
            }

            setupEventListeners() {
                document.getElementById('btnRefresh').addEventListener('click', () => {
                    this.clearCacheAndReload();
                });

                document.getElementById('btnTopGainers').addEventListener('click', async () => {
                    await this.showTopGainers();
                });

                document.getElementById('btnClearCache').addEventListener('click', () => {
                    this.service.clearCache();
                    this.updateCacheCount();
                    this.showToast('Ú©Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú© Ø´Ø¯', 'success');
                });

                document.getElementById('btnShowAnalysis').addEventListener('click', () => {
                    this.showAnalysis();
                });

                const searchInput = document.getElementById('searchInput');
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        this.searchCoins(e.target.value);
                    }, 500);
                });

                document.getElementById('btnCloseDetail').addEventListener('click', () => {
                    this.hideDetailView();
                });

                document.getElementById('btnCloseAnalysis').addEventListener('click', () => {
                    this.hideAnalysis();
                });
            }

            async loadInitialData() {
                try {
                    this.currentData = await this.service.getCoinsMarkets();
                    this.renderCryptoCards(this.currentData);
                    this.updateLastUpdateTime();
                } catch (error) {
                    this.showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§', 'error');
                    console.error('Load initial data error:', error);
                }
            }

            async searchCoins(query) {
                try {
                    const results = await this.service.searchCoins(query);
                    this.renderCryptoCards(results);
                } catch (error) {
                    console.error('Search error:', error);
                }
            }

            async showTopGainers() {
                try {
                    const gainers = await this.service.getTopGainers();
                    this.renderCryptoCards(gainers);
                    this.showToast('Û±Û° Ø±Ù…Ø²Ø§Ø±Ø² Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø±Ø´Ø¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯', 'success');
                } catch (error) {
                    this.showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø±Ø´Ø¯', 'error');
                }
            }

            async showCoinDetail(coinId) {
                try {
                    this.currentCoinId = coinId;
                    const coinData = await this.service.getCoinData(coinId);
                    this.renderDetailView(coinData);
                    this.showDetailView();
                } catch (error) {
                    this.showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ø±Ù…Ø²Ø§Ø±Ø²', 'error');
                }
            }

            renderCryptoCards(coins) {
                const grid = document.getElementById('cryptoGrid');
                grid.innerHTML = '';

                coins.forEach(coin => {
                    const card = this.createCryptoCard(coin);
                    grid.appendChild(card);
                });
            }

            createCryptoCard(coin) {
                const card = document.createElement('div');
                card.className = 'crypto-card';
                card.dataset.coinId = coin.id;

                const change24h = coin.price_change_percentage_24h || 0;
                const changeClass = change24h >= 0 ? 'positive' : 'negative';
                const changeIcon = change24h >= 0 ? 'trending-up' : 'trending-down';

                card.innerHTML = `
                    <div class="crypto-header">
                        <div class="crypto-name">
                            <img src="${coin.image}" alt="${coin.name}" 
                                 onerror="this.src='https://via.placeholder.com/32?text=â‚¿'">
                            <div>
                                <div class="crypto-symbol">${coin.symbol.toUpperCase()}</div>
                                <div>${coin.name}</div>
                            </div>
                        </div>
                        <div class="crypto-change ${changeClass}">
                            <i data-lucide="${changeIcon}"></i>
                            ${change24h.toFixed(2)}%
                        </div>
                    </div>
                    <div class="crypto-price">$${coin.current_price.toLocaleString()}</div>
                    <div class="crypto-info">
                        <div>
                            <small>Ø­Ø¬Ù… Ø¨Ø§Ø²Ø§Ø±</small>
                            <div>$${(coin.market_cap / 1000000000).toFixed(2)}B</div>
                        </div>
                        <div>
                            <small>Ø­Ø¬Ù… 24h</small>
                            <div>$${(coin.total_volume / 1000000000).toFixed(2)}B</div>
                        </div>
                        <div>
                            <small>ØªØºÛŒÛŒØ± 7d</small>
                            <div class="${coin.price_change_percentage_7d_in_currency >= 0 ? 'positive' : 'negative'}">
                                ${coin.price_change_percentage_7d_in_currency?.toFixed(2) || '0.00'}%
                            </div>
                        </div>
                    </div>
                `;

                card.addEventListener('click', () => {
                    this.showCoinDetail(coin.id);
                });

                setTimeout(() => lucide.createIcons(), 0);
                return card;
            }

            renderDetailView(coinData) {
                document.getElementById('detailSymbol').textContent = 
                    `${coinData.name} (${coinData.symbol.toUpperCase()})`;
                
                document.getElementById('statPrice').textContent = 
                    `$${coinData.market_data.current_price.usd.toLocaleString()}`;
                
                const change24h = coinData.market_data.price_change_percentage_24h;
                const changeElement = document.getElementById('statChange24h');
                changeElement.textContent = `${change24h >= 0 ? '+' : ''}${change24h.toFixed(2)}%`;
                changeElement.className = change24h >= 0 ? 'positive' : 'negative';
                
                document.getElementById('statMarketCap').textContent = 
                    `$${(coinData.market_data.market_cap.usd / 1000000000).toFixed(2)}B`;
                
                document.getElementById('statHigh24h').textContent = 
                    `$${coinData.market_data.high_24h.usd.toLocaleString()}`;
                
                document.getElementById('statLow24h').textContent = 
                    `$${coinData.market_data.low_24h.usd.toLocaleString()}`;
                
                document.getElementById('statCirculatingSupply').textContent = 
                    `${(coinData.market_data.circulating_supply || 0).toLocaleString()}`;

                this.createPriceChart(coinData);
            }

            createPriceChart(coinData) {
                const ctx = document.getElementById('priceChart').getContext('2d');
                
                if (this.chart) {
                    this.chart.destroy();
                }

                const labels = [];
                const prices = [];
                
                for (let i = 23; i >= 0; i--) {
                    const time = new Date();
                    time.setHours(time.getHours() - i);
                    labels.push(time.getHours() + ':00');
                    
                    const basePrice = coinData.market_data.current_price.usd;
                    const fluctuation = (Math.random() - 0.5) * 0.1 * basePrice;
                    prices.push(basePrice + fluctuation);
                }

                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Ù‚ÛŒÙ…Øª (USD)',
                            data: prices,
                            borderColor: '#8a2be2',
                            backgroundColor: 'rgba(138, 43, 226, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                rtl: true,
                                labels: {
                                    font: {
                                        family: 'Vazirmatn'
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            }

            showDetailView() {
                document.querySelector('.crypto-grid').classList.add('hidden');
                document.getElementById('detailView').classList.remove('hidden');
            }

            hideDetailView() {
                document.getElementById('detailView').classList.add('hidden');
                document.querySelector('.crypto-grid').classList.remove('hidden');
            }

            showAnalysis() {
                const analysisHTML = this.generateAnalysis();
                document.getElementById('analysisBody').innerHTML = analysisHTML;
                document.getElementById('analysisSection').classList.remove('hidden');
                
                setTimeout(() => lucide.createIcons(), 0);
            }

            hideAnalysis() {
                document.getElementById('analysisSection').classList.add('hidden');
            }

            generateAnalysis() {
                if (this.currentData.length === 0) return '<p>Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>';
                
                const totalCoins = this.currentData.length;
                const positiveCoins = this.currentData.filter(coin => coin.price_change_percentage_24h > 0).length;
                const negativeCoins = this.currentData.filter(coin => coin.price_change_percentage_24h < 0).length;
                const avgChange = this.currentData.reduce((sum, coin) => sum + coin.price_change_percentage_24h, 0) / totalCoins;
                const totalMarketCap = this.currentData.reduce((sum, coin) => sum + coin.market_cap, 0);
                const topPerformer = this.currentData.reduce((max, coin) => 
                    coin.price_change_percentage_24h > max.price_change_percentage_24h ? coin : max
                );
                const worstPerformer = this.currentData.reduce((min, coin) => 
                    coin.price_change_percentage_24h < min.price_change_percentage_24h ? coin : min
                );
                
                return `
                    <div class="analysis-cards">
                        <div class="analysis-card">
                            <h4><i data-lucide="trending-up"></i> Ø®Ù„Ø§ØµÙ‡ Ø¨Ø§Ø²Ø§Ø±</h4>
                            <p>ğŸ“Š Ù…Ø¬Ù…ÙˆØ¹ Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§: ${totalCoins}</p>
                            <p>ğŸ“ˆ Ù…Ø«Ø¨Øª: ${positiveCoins} | ğŸ“‰ Ù…Ù†ÙÛŒ: ${negativeCoins}</p>
                            <p>ğŸ’° Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ØªØºÛŒÛŒØ±: ${avgChange.toFixed(2)}%</p>
                            <p>ğŸ† Ø­Ø¬Ù… Ú©Ù„ Ø¨Ø§Ø²Ø§Ø±: $${(totalMarketCap / 1000000000).toFixed(2)}B</p>
                        </div>
                        
                        <div class="analysis-card">
                            <h4><i data-lucide="award"></i> Ø¨Ù‡ØªØ±ÛŒÙ† Ø¹Ù…Ù„Ú©Ø±Ø¯</h4>
                            <p>${topPerformer.name} (${topPerformer.symbol.toUpperCase()})</p>
                            <p class="positive">ğŸ“ˆ +${topPerformer.price_change_percentage_24h.toFixed(2)}%</p>
                            <p>Ù‚ÛŒÙ…Øª: $${topPerformer.current_price.toLocaleString()}</p>
                        </div>
                        
                        <div class="analysis-card">
                            <h4><i data-lucide="alert-triangle"></i> Ø¨Ø¯ØªØ±ÛŒÙ† Ø¹Ù…Ù„Ú©Ø±Ø¯</h4>
                            <p>${worstPerformer.name} (${worstPerformer.symbol.toUpperCase()})</p>
                            <p class="negative">ğŸ“‰ ${worstPerformer.price_change_percentage_24h.toFixed(2)}%</p>
                            <p>Ù‚ÛŒÙ…Øª: $${worstPerformer.current_price.toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <div class="analysis-recommendation">
                        <h4><i data-lucide="lightbulb"></i> ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§ÛŒ ØªØ­Ù„ÛŒÙ„</h4>
                        <p>${this.getMarketRecommendation(avgChange)}</p>
                        <p>${this.getTradingAdvice(positiveCoins, totalCoins)}</p>
                    </div>
                `;
            }

            getMarketRecommendation(avgChange) {
                if (avgChange > 5) return 'ğŸ”´ Ø¨Ø§Ø²Ø§Ø± Ø¯Ø± ÙˆØ¶Ø¹ÛŒØª Ú¯Ø±Ù… - Ù…Ø±Ø§Ù‚Ø¨ Ø§ØµÙ„Ø§Ø­ Ù‚ÛŒÙ…Øª Ø¨Ø§Ø´ÛŒØ¯';
                if (avgChange > 2) return 'ğŸŸ¡ Ø¨Ø§Ø²Ø§Ø± ØµØ¹ÙˆØ¯ÛŒ - Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø·';
                if (avgChange > -2) return 'ğŸŸ¢ Ø¨Ø§Ø²Ø§Ø± Ø®Ù†Ø«ÛŒ - ÙØ±ØµØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ Ø®ÙˆØ¨';
                if (avgChange > -5) return 'ğŸŸ  Ø¨Ø§Ø²Ø§Ø± Ù†Ø²ÙˆÙ„ÛŒ - Ù…Ù†ØªØ¸Ø± Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¨Ø±Ú¯Ø´Øª Ø¨Ø§Ø´ÛŒØ¯';
                return 'ğŸ”´ Ø¨Ø§Ø²Ø§Ø± Ø¯Ø± ÙˆØ¶Ø¹ÛŒØª Ø§ØµÙ„Ø§Ø­ Ø´Ø¯ÛŒØ¯ - Ù…Ù†ØªØ¸Ø± Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÛŒØ¯ Ø¨Ø§Ø´ÛŒØ¯';
            }

            getTradingAdvice(positiveCoins, totalCoins) {
                const ratio = positiveCoins / totalCoins;
                if (ratio > 0.7) return 'ğŸ’¡ Ø¨Ø§Ø²Ø§Ø± Ú©Ù„ÛŒ ØµØ¹ÙˆØ¯ÛŒ Ø§Ø³Øª - Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø®Ø±ÛŒØ¯ Ø¯Ø± Ø§ØµÙ„Ø§Ø­Ø§Øª';
                if (ratio > 0.4) return 'âš–ï¸ Ø¨Ø§Ø²Ø§Ø± Ù…Ø®ØªÙ„Ø· - Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ù‡Ù…â€ŒÙ‡Ø§ÛŒ Ù‚ÙˆÛŒ Ù…Ù‡Ù… Ø§Ø³Øª';
                return 'ğŸ“‰ Ø¨Ø§Ø²Ø§Ø± Ú©Ù„ÛŒ Ù†Ø²ÙˆÙ„ÛŒ Ø§Ø³Øª - Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ ÙØ±ÙˆØ´ Ø¯Ø± Ù…Ù‚Ø§ÙˆÙ…Øªâ€ŒÙ‡Ø§';
            }

            hideLoading() {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            }

            updateLastUpdateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('fa-IR');
                document.getElementById('lastUpdateTime').textContent = timeString;
            }

            updateCacheCount() {
                const count = this.service.getCachedCount();
                document.getElementById('cachedCount').textContent = count;
            }

            async clearCacheAndReload() {
                this.service.clearCache();
                this.updateCacheCount();
                await this.loadInitialData();
                this.showToast('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯', 'success');
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                    color: white;
                    padding: 12px 24px;
                    border-radius: 12px;
                    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                    z-index: 10000;
                    animation: slideDown 0.3s ease;
                `;
                
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideUp 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        }

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ toast
        const toastStyles = document.createElement('style');
        toastStyles.textContent = `
            @keyframes slideDown {
                from {
                    transform: translateX(-50%) translateY(-100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(-50%) translateY(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideUp {
                from {
                    transform: translateX(-50%) translateY(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(-50%) translateY(-100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(toastStyles);

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†
        document.addEventListener('DOMContentLoaded', () => {
            window.cryptoApp = new CryptoApp();
        });
    </script>
    
    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù…Ù„ */
        :root {
            --primary-color: #8a2be2;
            --secondary-color: #4a00e0;
            --accent-color: #ff6b6b;
            --dark-color: #1a1a2e;
            --light-color: #f8f9fa;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --gray-color: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        .app-header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            text-align: center;
        }

        .app-header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .app-header p {
            color: var(--gray-color);
            margin-bottom: 15px;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            background: rgba(138, 43, 226, 0.1);
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .api-status {
            color: var(--success-color);
            font-weight: bold;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            margin-bottom: 25px;
        }

        .controls {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
        }

        .search-box {
            position: relative;
            max-width: 500px;
            margin: 0 auto 20px;
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .search-box input {
            width: 100%;
            padding: 15px 45px 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.1);
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: #333;
        }

        .btn-success {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f6d365, #fda085);
            color: #333;
        }

        .btn-close {
            background: var(--danger-color);
            color: white;
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .stats span {
            background: rgba(138, 43, 226, 0.1);
            padding: 10px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .crypto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .crypto-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: var(--transition);
            border: 2px solid transparent;
            cursor: pointer;
        }

        .crypto-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
            border-color: var(--primary-color);
        }

        .crypto-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .crypto-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .crypto-name img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .crypto-symbol {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .crypto-price {
            font-size: 1.4rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .positive {
            color: var(--success-color);
        }

        .negative {
            color: var(--danger-color);
        }

        .crypto-info {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .detail-view {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-top: 30px;
            box-shadow: var(--box-shadow);
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .detail-body {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        @media (max-width: 992px) {
            .detail-body {
                grid-template-columns: 1fr;
            }
        }

        .price-chart-container {
            background: rgba(138, 43, 226, 0.05);
            border-radius: var(--border-radius);
            padding: 20px;
            height: 400px;
        }

        .detail-stats {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 2px solid rgba(138, 43, 226, 0.1);
        }

        .stat-card h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .app-footer {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            text-align: center;
        }

        .app-footer p {
            margin-bottom: 15px;
            color: var(--dark-color);
        }

        .footer-note {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-top: 15px;
        }

        .analysis-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-top: 30px;
            box-shadow: var(--box-shadow);
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .analysis-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .analysis-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
        }

        .analysis-card h4 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-card p {
            margin: 8px 0;
        }

        .analysis-recommendation {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
        }

        .analysis-recommendation h4 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .creator-note {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .crypto-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .header-info {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .control-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            button {
                width: 100%;
            }
            
            .stats {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            #app {
                padding: 10px;
            }
            
            .app-header, .main-container, .app-footer {
                padding: 15px;
            }
            
            .crypto-grid {
                grid-template-columns: 1fr;
            }
            
            .analysis-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>
